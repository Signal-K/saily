services:
  supabase:
    image: node:20-alpine
    working_dir: /workspace
    volumes:
      - ./:/workspace
      - /var/run/docker.sock:/var/run/docker.sock
      - supabase-cli-cache:/root/.npm
    environment:
      DOCKER_HOST: unix:///var/run/docker.sock
    command: >
      sh -lc "
      apk add --no-cache docker-cli >/dev/null &&
      npx --yes supabase@2 start --workdir /workspace &&
      tail -f /dev/null
      "

  web:
    build:
      context: ./web
      target: dev
    working_dir: /app
    volumes:
      - ./web:/app
      - web_node_modules:/app/node_modules
    ports:
      - "3000:3000"
    environment:
      NEXT_PUBLIC_SUPABASE_URL: ${NEXT_PUBLIC_SUPABASE_URL:-http://localhost:54321}
      SUPABASE_URL_INTERNAL: ${SUPABASE_URL_INTERNAL:-http://host.docker.internal:54321}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${NEXT_PUBLIC_SUPABASE_ANON_KEY:-sb_publishable_ACJWlzQHlZjBrEguHvfOxg_3BJgxAaH}
      NEXT_PUBLIC_AUTH_GOOGLE_ENABLED: ${NEXT_PUBLIC_AUTH_GOOGLE_ENABLED:-false}
      WATCHPACK_POLLING: "true"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - supabase

volumes:
  web_node_modules:
  supabase-cli-cache:
